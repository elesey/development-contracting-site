---
/**
 * StickyHeader Component
 *
 * Static header shell with minimal JS for scroll + mobile menu.
 */
import { company, mainNavigation } from "@/data";

type NavLink = {
  name: string;
  href: string;
  description?: string;
};

type NavItem = NavLink & {
  primary?: boolean;
  submenu?: NavLink[];
};

const navItems: NavItem[] = mainNavigation.map((item) => ({
  name: item.name,
  href: item.href,
  submenu: item.submenu?.map((submenu) => ({
    name: submenu.name,
    href: submenu.href,
    description: submenu.description,
  })),
}));
const mobileNavItems: NavLink[] = navItems.flatMap((item) =>
  item.submenu
    ? item.submenu.map(({ name, href }) => ({ name, href }))
    : [{ name: item.name, href: item.href }],
);

const desktopNavItems: NavItem[] = navItems;
const companyWords = company.name.split(" ");
const companyPrimary = companyWords[0] ?? company.name;
const companySecondary = companyWords.slice(1).join(" ") || "Contracting";
---

<header
  class="fixed top-0 right-0 left-0 z-50 origin-top transition-all duration-500"
  id="homepage-header"
>
  <div
    class="from-bone/95 via-bone/80 absolute inset-0 bg-gradient-to-b to-transparent transition-all duration-500"
    id="header-backdrop"
  >
  </div>

  <div
    class="container-homepage relative flex items-center justify-between py-5 transition-all duration-500"
    id="header-inner"
  >
    <a href="/" class="group relative z-10 flex items-center gap-3">
      <div
        class="border-evergreen/20 bg-clean-white group-hover:border-evergreen/60 group-hover:shadow-evergreen/10 flex h-12 w-12 items-center justify-center rounded border transition-all duration-300 group-hover:shadow-lg"
      >
        <span class="text-evergreen text-lg font-semibold">DC</span>
      </div>
      <div class="hidden sm:block">
        <span
          class="text-evergreen block font-serif text-lg font-semibold tracking-tight"
        >
          {companyPrimary}
        </span>
        <span class="text-slate block text-[10px] tracking-[0.3em] uppercase">
          {companySecondary}
        </span>
      </div>
    </a>

    <nav class="hidden items-center gap-1 lg:flex">
      {
        desktopNavItems.map((item) => (
          <div class="nav-item group relative">
            <a
              href={item.href}
              class="text-charcoal hover:text-evergreen relative px-4 py-2 text-sm font-medium transition-colors"
            >
              <span class="relative z-10">{item.name}</span>
            </a>
            {item.submenu && (
              <div class="nav-dropdown">
                <div class="nav-dropdown-inner">
                  {item.submenu.map((submenu) => (
                    <a href={submenu.href} class="nav-dropdown-link">
                      <span class="nav-dropdown-title">{submenu.name}</span>
                      {submenu.description && (
                        <span class="nav-dropdown-desc">
                          {submenu.description}
                        </span>
                      )}
                    </a>
                  ))}
                </div>
              </div>
            )}
          </div>
        ))
      }
    </nav>

    <div class="hidden items-center gap-4 lg:flex">
      <a
        href={company.phoneHref}
        class="text-slate hover:text-evergreen flex items-center gap-2 text-sm font-medium transition-colors"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-4 w-4"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
          ></path>
        </svg>
        {company.phone}
      </a>
      <a href="#contact" class="btn-primary">Call Now</a>
    </div>

    <div class="flex items-center gap-3 lg:hidden">
      <a
        href={company.phoneHref}
        class="bg-copper flex items-center justify-center rounded-full px-4 py-2 text-sm font-semibold text-white shadow-md"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="mr-1.5 h-4 w-4"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
          ></path>
        </svg>
        Call
      </a>
      <button
        class="border-driftwood/60 text-evergreen flex h-10 w-10 items-center justify-center rounded-full border"
        id="mobile-menu-btn"
        aria-label="Toggle menu"
        type="button"
      >
        <span class="flex flex-col gap-1.5" id="hamburger-icon">
          <span
            class="bg-evergreen block h-0.5 w-5 transition-transform duration-300"
          ></span>
          <span
            class="bg-evergreen block h-0.5 w-5 transition-opacity duration-300"
          ></span>
          <span
            class="bg-evergreen block h-0.5 w-5 transition-transform duration-300"
          ></span>
        </span>
      </button>
    </div>
  </div>
</header>

<div class="fixed inset-0 z-[60] hidden" id="mobile-menu">
  <div
    class="absolute inset-0 bg-black/60 backdrop-blur-md"
    id="mobile-menu-backdrop"
  >
  </div>
  <div
    class="pointer-events-none relative flex h-full flex-col items-center justify-center gap-8"
  >
    {
      mobileNavItems.map((item, index) => (
        <a
          href={item.href}
          class="mobile-nav-link hover:text-copper pointer-events-auto text-2xl tracking-widest text-white uppercase opacity-0 transition-all duration-300"
          style={`animation-delay: ${index * 100}ms`}
        >
          {item.name}
        </a>
      ))
    }
    <a
      href={company.phoneHref}
      class="mobile-nav-link text-copper pointer-events-auto mt-8 flex items-center gap-2 opacity-0 transition-all duration-300"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="1.5"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z"
        ></path>
      </svg>
      <span class="text-lg font-medium">{company.phone}</span>
    </a>
  </div>
</div>

<div class="h-20"></div>

<script>
  declare global {
    interface Window {
      __homepageHeaderAbort?: AbortController;
    }
  }

  window.__homepageHeaderAbort?.abort();
  window.__homepageHeaderAbort = new AbortController();
  const { signal } = window.__homepageHeaderAbort;

  const header = document.getElementById("homepage-header");
  const headerInner = document.getElementById("header-inner");
  const backdrop = document.getElementById("header-backdrop");

  function handleScroll() {
    if (window.scrollY > 50) {
      header?.classList.add("scale-[0.96]");
      headerInner?.classList.add("py-3");
      headerInner?.classList.remove("py-5");
      backdrop?.classList.add(
        "bg-bone/95",
        "backdrop-blur-md",
        "shadow-lg",
        "shadow-black/10",
      );
      backdrop?.classList.remove(
        "bg-gradient-to-b",
        "from-bone/95",
        "via-bone/80",
        "to-transparent",
      );
    } else {
      header?.classList.remove("scale-[0.96]");
      headerInner?.classList.remove("py-3");
      headerInner?.classList.add("py-5");
      backdrop?.classList.remove(
        "bg-bone/95",
        "backdrop-blur-md",
        "shadow-lg",
        "shadow-black/10",
      );
      backdrop?.classList.add(
        "bg-gradient-to-b",
        "from-bone/95",
        "via-bone/80",
        "to-transparent",
      );
    }
  }

  window.addEventListener("scroll", handleScroll, { signal });
  handleScroll();

  const mobileMenuBtn = document.getElementById(
    "mobile-menu-btn",
  ) as HTMLButtonElement | null;
  const mobileMenu = document.getElementById(
    "mobile-menu",
  ) as HTMLDivElement | null;
  const mobileMenuBackdrop = document.getElementById(
    "mobile-menu-backdrop",
  ) as HTMLDivElement | null;
  const hamburgerIcon = document.getElementById(
    "hamburger-icon",
  ) as HTMLSpanElement | null;
  const mobileNavLinks = document.querySelectorAll(
    ".mobile-nav-link",
  ) as NodeListOf<HTMLElement>;

  let isMenuOpen = false;
  let closeMenuTimeout: ReturnType<typeof setTimeout> | null = null;
  let animationTimeouts: Array<ReturnType<typeof setTimeout>> = [];

  function clearTimeouts() {
    animationTimeouts.forEach((timeoutId) => clearTimeout(timeoutId));
    animationTimeouts = [];
    if (closeMenuTimeout) {
      clearTimeout(closeMenuTimeout);
      closeMenuTimeout = null;
    }
  }

  signal.addEventListener("abort", () => {
    clearTimeouts();
  });

  function openMenu() {
    clearTimeouts();
    isMenuOpen = true;
    mobileMenu?.classList.remove("hidden");
    document.body.style.overflow = "hidden";

    const spans = hamburgerIcon?.querySelectorAll("span");
    if (spans) {
      spans[0].style.transform = "rotate(45deg) translate(4px, 4px)";
      spans[1].style.opacity = "0";
      spans[2].style.transform = "rotate(-45deg) translate(4px, -4px)";
    }

    mobileNavLinks.forEach((link, index) => {
      const timeoutId = setTimeout(() => {
        link.style.opacity = "1";
        link.style.transform = "translateY(0)";
      }, index * 100);
      animationTimeouts.push(timeoutId);
    });
  }

  function closeMenu() {
    isMenuOpen = false;
    animationTimeouts.forEach((timeoutId) => clearTimeout(timeoutId));
    animationTimeouts = [];

    const spans = hamburgerIcon?.querySelectorAll("span");
    if (spans) {
      spans[0].style.transform = "";
      spans[1].style.opacity = "1";
      spans[2].style.transform = "";
    }

    mobileNavLinks.forEach((link) => {
      link.style.opacity = "0";
      link.style.transform = "translateY(20px)";
    });

    closeMenuTimeout = setTimeout(() => {
      mobileMenu?.classList.add("hidden");
      document.body.style.overflow = "";
      closeMenuTimeout = null;
    }, 300);
  }

  mobileMenuBtn?.addEventListener(
    "click",
    () => {
      if (isMenuOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    },
    { signal },
  );

  mobileMenuBackdrop?.addEventListener(
    "click",
    () => {
      closeMenu();
    },
    { signal },
  );

  mobileNavLinks.forEach((link) => {
    link.addEventListener(
      "click",
      () => {
        closeMenu();
      },
      { signal },
    );
  });
</script>

<style>
  .mobile-nav-link {
    transform: translateY(20px);
  }

  .nav-item:hover .nav-dropdown,
  .nav-item:focus-within .nav-dropdown {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }

  .nav-dropdown {
    position: absolute;
    top: calc(100% + 0.75rem);
    left: 0;
    opacity: 0;
    pointer-events: none;
    transform: translateY(8px);
    transition: all 0.2s ease;
    z-index: 40;
  }

  .nav-dropdown-inner {
    min-width: 14rem;
    border-radius: 0.75rem;
    border: 1px solid rgba(143, 135, 125, 0.2);
    background: rgba(255, 255, 255, 0.95);
    padding: 0.5rem;
    box-shadow: 0 20px 30px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(14px);
  }

  .nav-dropdown-link {
    display: block;
    border-radius: 0.625rem;
    padding: 0.75rem 0.9rem;
    color: var(--color-charcoal);
    transition:
      background 0.2s ease,
      color 0.2s ease;
  }

  .nav-dropdown-link:hover {
    background: rgba(230, 240, 237, 0.6);
    color: var(--color-evergreen);
  }

  .nav-dropdown-title {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .nav-dropdown-desc {
    display: block;
    margin-top: 0.2rem;
    font-size: 0.75rem;
    color: rgba(51, 65, 85, 0.7);
  }
</style>
